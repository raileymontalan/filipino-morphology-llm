# Pre-commit hooks for filipino-morphology-llm
# Install: pip install pre-commit && pre-commit install
# Run manually: pre-commit run --all-files


repos:
  # Code formatting
  - repo: https://github.com/psf/black
    rev: 24.3.0
    hooks:
      - id: black
        name: Format Python code with Black
        language_version: python3.11
        args: ['--line-length=120']
        exclude: ^(env/|cache/|container_cache/|nemo_experiments/|\.vscode/|training/stochastok/)

  # Python linting and import sorting with Ruff
  # - repo: https://github.com/astral-sh/ruff-pre-commit
  #   rev: v0.4.4
  #   hooks:
  #     - id: ruff
  #       name: Lint Python with Ruff
  #       args: [
  #         '--line-length=120',
  #         '--extend-exclude=env,cache,container_cache,nemo_experiments,.vscode,training/stochastok/',
  #         '--select=ALL',
  #         '--ignore=E203',
  #       ]

  # Essential pre-commit hooks
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: Trim trailing whitespace
        exclude: ^(\.gitignore|.*\.md|env/|cache/|training/stochastok/)

      - id: end-of-file-fixer
        name: Fix end of files
        exclude: ^(env/|cache/|container_cache/|\.vscode/|training/stochastok/)

      - id: check-yaml
        name: Check YAML syntax
        exclude: ^(env/|cache/|container_cache/|training/stochastok/)

      - id: check-json
        name: Check JSON syntax
        exclude: ^(data/|env/|cache/|container_cache/|src/tokenization/expansions/|training/stochastok/)

      - id: check-added-large-files
        name: Check for large files (>5MB)
        args: ['--maxkb=5120']
        exclude: ^(data/|cache/|container_cache/|results/|logs/|training/stochastok/)

      - id: check-case-conflict
        name: Check for case conflicts

      - id: check-merge-conflict
        name: Check for merge conflicts

      - id: detect-private-key
        name: Detect private keys

      - id: mixed-line-ending
        name: Check mixed line endings
        args: ['--fix=lf']
        exclude: ^(env/|cache/|container_cache/|training/stochastok/)

  # Prevent committing to main
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: no-commit-to-branch
        name: Prevent direct commits to main
        args: ['--branch', 'main', '--branch', 'master']
        stages: [pre-commit]

  # Custom hooks for this project
  - repo: local
    hooks:
      - id: check-sys-path-pattern
        name: Check for inconsistent sys.path patterns
        entry: bash
        args:
          - -c
          - >
            if git diff --cached --name-only --diff-filter=AM | xargs grep -l 'sys\.path\.insert(0, "src")' 2>/dev/null;
            then
              echo "ERROR: Found old sys.path pattern.";
              echo 'Use: sys.path.insert(0, str(Path(__file__).parent.parent / "src"))';
              exit 1;
            fi
        language: system
        pass_filenames: false

      - id: check-test-naming
        name: Check test file naming convention
        entry: bash
        args:
          - -c
          - >
            for f in tests/*.py; do
              if [[ -f "$f" && ! "$f" =~ tests/(test_|__init__|conftest|demo_) ]]; then
                echo "ERROR: Test file $f does not follow test_*.py convention";
                exit 1;
              fi;
            done
        language: system
        pass_filenames: false

# Configuration for black
exclude: |
  (?x)^(
    env/.*|
    cache/.*|
    container_cache/.*|
    nemo_experiments/.*|
    \.vscode/.*|
    data/expansions/.*\.json|
    src/tokenization/expansions/.*\.json|
    training/stochastok/.*
  )$
