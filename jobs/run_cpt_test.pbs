#!/bin/bash

#PBS -N gemma3_cpt_test
#PBS -l select=1:ncpus=8:ngpus=1:mem=64GB
#PBS -l walltime=01:00:00
#PBS -q AISG_debug
#PBS -j oe
#PBS -o /scratch_aisg/SPEC-SF-AISG/railey/logs/

# ============================================================================
# PBS Job Script for Testing CPT with NeMo Framework Container (Single GPU)
# ============================================================================
#
# This is a simplified single-GPU test version for quick validation.
# Use run_cpt.pbs for multi-GPU training.
#
# Usage:
#   qsub jobs/run_cpt_test.pbs
#
# ============================================================================

set -euo pipefail

# ============================================================================
# Setup Environment
# ============================================================================

export JOB_WORK_DIR=${PBS_O_WORKDIR}
export JOB_ID=${PBS_JOBID}
export JOB_NAME=${PBS_JOBNAME}

cd ${JOB_WORK_DIR}

# Activate Python environment
if [ -f "${JOB_WORK_DIR}/env/bin/activate" ]; then
    source "${JOB_WORK_DIR}/env/bin/activate"
else
    echo "Warning: Python environment not found at ${JOB_WORK_DIR}/env/bin/activate"
fi

# Load environment variables
if [ -f "${JOB_WORK_DIR}/.env" ]; then
    echo "Loading environment from .env file..."
    source "${JOB_WORK_DIR}/.env"
else
    echo "Error: .env file not found at ${JOB_WORK_DIR}/.env"
    exit 1
fi

# ============================================================================
# Container Configuration
# ============================================================================

export CONTAINER_NAME="nemo_framework"

if ! enroot list | grep -q "^${CONTAINER_NAME}$"; then
    echo "Error: Container ${CONTAINER_NAME} not found"
    echo "Please run setup_enroot.sh first"
    exit 1
fi

# ============================================================================
# Directory Setup
# ============================================================================

export LOG_DIR="/scratch_aisg/SPEC-SF-AISG/railey/logs/training/${JOB_ID}"
export CKPT_DIR="/scratch_aisg/SPEC-SF-AISG/railey/logs/checkpoints/gemma3-cpt-test-${JOB_ID}"

mkdir -p ${LOG_DIR}
mkdir -p ${CKPT_DIR}

# ============================================================================
# Test Configuration (Small values for quick testing)
# ============================================================================

# Single path or multiple chunk paths (space-separated)
# Note: Paths now include tokenizer name for organization
export DATA_PATH="/workspace/data/processed/google-gemma-3-1b-pt/seapile-v2"
export SEQ_LENGTH=512
export MAX_STEPS=10
export GBS=4
export MBS=1
export DEVICES=1
export LR=1e-4
export MIN_LR=1e-5
export WARMUP_STEPS=5
export CKPT_INTERVAL=5
export RESUME_FROM="google/gemma-3-1b-pt"
export WANDB_PROJECT="gemma3-cpt-test"
export WANDB_NAME="test-${JOB_ID}"
export LOG_EVERY_N_STEPS=1
export VAL_CHECK_INTERVAL=5

# ============================================================================
# Build Python Command
# ============================================================================

PYTHON_CMD="python /workspace/training/nemo/run_cpt.py \
    --data-path ${DATA_PATH} \
    --seq-length ${SEQ_LENGTH} \
    --max-steps ${MAX_STEPS} \
    --global-batch-size ${GBS} \
    --micro-batch-size ${MBS} \
    --devices ${DEVICES} \
    --lr ${LR} \
    --min-lr ${MIN_LR} \
    --warmup-steps ${WARMUP_STEPS} \
    --checkpoint-dir ${CKPT_DIR} \
    --checkpoint-interval ${CKPT_INTERVAL} \
    --resume-from ${RESUME_FROM} \
    --wandb-project ${WANDB_PROJECT} \
    --wandb-name ${WANDB_NAME} \
    --log-dir ${LOG_DIR} \
    --log-every-n-steps ${LOG_EVERY_N_STEPS} \
    --val-check-interval ${VAL_CHECK_INTERVAL}"

# ============================================================================
# Print Configuration
# ============================================================================

echo "============================================================================"
echo "Test Run Configuration"
echo "============================================================================"
echo "Job ID: ${JOB_ID}"
echo "Container: ${CONTAINER_NAME}"
echo ""
echo "Training Configuration:"
echo "  Max Steps: ${MAX_STEPS}"
echo "  Sequence Length: ${SEQ_LENGTH}"
echo "  Global Batch Size: ${GBS}"
echo "  Devices: ${DEVICES}"
echo ""
echo "Output:"
echo "  Logs: ${LOG_DIR}"
echo "  Checkpoints: ${CKPT_DIR}"
echo "============================================================================"
echo ""

# ============================================================================
# Build Enroot Command
# ============================================================================

ENROOT_MOUNTS="--mount ${JOB_WORK_DIR}:/workspace"

if [ -n "${BIND_MOUNTS:-}" ]; then
    IFS=',' read -ra MOUNTS <<< "$BIND_MOUNTS"
    for mount in "${MOUNTS[@]}"; do
        ENROOT_MOUNTS="${ENROOT_MOUNTS} --mount ${mount}"
    done
fi

ENROOT_ENV="-e HF_HOME=${HF_HOME} \
    -e WANDB_API_KEY=${WANDB_API_KEY} \
    -e WANDB_DIR=${WANDB_DIR} \
    -e LOG_DIR=${LOG_DIR} \
    -e CKPT_DIR=${CKPT_DIR}"

# ============================================================================
# Launch Test Run
# ============================================================================

echo "Launching test run..."
echo ""

enroot start --rw \
    ${ENROOT_ENV} \
    ${ENROOT_MOUNTS} \
    ${CONTAINER_NAME} \
    bash -c "${PYTHON_CMD}" 2>&1 | tee ${LOG_DIR}/test_run.log

echo ""
echo "============================================================================"
echo "Test Run Completed"
echo "============================================================================"
echo "Check logs at: ${LOG_DIR}"
echo "============================================================================"
