#!/bin/bash

#PBS -N preprocess_chunk1
#PBS -l select=1:ncpus=32:mem=256GB
#PBS -l walltime=02:00:00
#PBS -q AISG_debug
#PBS -j oe
#PBS -o /scratch_aisg/SPEC-SF-AISG/railey/logs/

# ============================================================================
# Test Data Preprocessing - Single Chunk
# ============================================================================
# This is a test script to preprocess just one chunk to verify everything works
# ============================================================================

set -euo pipefail

# ============================================================================
# Setup Environment
# ============================================================================

export JOB_WORK_DIR=${PBS_O_WORKDIR}
export JOB_ID=${PBS_JOBID}
export JOB_NAME=${PBS_JOBNAME}

cd ${JOB_WORK_DIR}

# Load environment variables
if [ -f "${JOB_WORK_DIR}/.env" ]; then
    set +u  # Temporarily allow undefined variables
    source "${JOB_WORK_DIR}/.env"
    set -u
else
    echo "Error: .env file not found"
    exit 1
fi

# Export Enroot paths (critical!)
export ENROOT_PATH=${ENROOT_PATH}
export ENROOT_CACHE_PATH=${ENROOT_CACHE_PATH}
export ENROOT_TEMP_PATH=${ENROOT_TEMP_PATH}
export ENROOT_DATA_PATH=${ENROOT_DATA_PATH}
export ENROOT_RUNTIME_PATH=${ENROOT_RUNTIME_PATH}

# ============================================================================
# Container Configuration
# ============================================================================

export CONTAINER_NAME="nemo_framework"

if ! enroot list | grep -q "^${CONTAINER_NAME}$"; then
    echo "Error: Container ${CONTAINER_NAME} not found"
    echo "Run: bash setup_enroot.sh"
    exit 1
fi

# ============================================================================
# Configuration
# ============================================================================

export CHUNK_NUM=1
export CHUNK_FILE_HOST="${JOB_WORK_DIR}/data/chunks/chunk_$(printf '%04d' ${CHUNK_NUM}).jsonl"
export CHUNK_FILE_CONTAINER="/workspace/data/chunks/chunk_$(printf '%04d' ${CHUNK_NUM}).jsonl"
export OUTPUT_PREFIX_CONTAINER="/workspace/data/processed/chunk_$(printf '%04d' ${CHUNK_NUM})"
export TOKENIZER="google/gemma-3-1b-pt"
export WORKERS=32
export JSON_KEY="text"

export LOG_DIR="/scratch_aisg/SPEC-SF-AISG/railey/logs/preprocessing/${PBS_JOBID%%.*}/chunk_${CHUNK_NUM}"
mkdir -p ${LOG_DIR}

# ============================================================================
# Print Configuration
# ============================================================================

echo "============================================================================"
echo "Test Preprocessing - Chunk ${CHUNK_NUM}"
echo "============================================================================"
echo "Job ID: ${PBS_JOBID}"
echo ""
echo "Input (host): ${CHUNK_FILE_HOST}"
echo "Input (container): ${CHUNK_FILE_CONTAINER}"
echo "Output: ${OUTPUT_PREFIX_CONTAINER}.{bin,idx}"
echo "Tokenizer: ${TOKENIZER}"
echo "Workers: ${WORKERS}"
echo "============================================================================"
echo ""

# ============================================================================
# Verify Input Exists
# ============================================================================

if [ ! -f "${CHUNK_FILE_HOST}" ]; then
    echo "✗ Error: Chunk file not found: ${CHUNK_FILE_HOST}"
    echo ""
    echo "Available chunks:"
    ls -lh "${JOB_WORK_DIR}/data/chunks/" || echo "Directory doesn't exist!"
    exit 1
fi

echo "✓ Chunk file found: ${CHUNK_FILE_HOST}"
echo "  Size: $(du -h ${CHUNK_FILE_HOST} | cut -f1)"
echo "  Lines: $(wc -l < ${CHUNK_FILE_HOST})"
echo ""

# ============================================================================
# Build Enroot Command
# ============================================================================

ENROOT_MOUNTS="--mount ${JOB_WORK_DIR}:/workspace"

if [ -n "${BIND_MOUNTS:-}" ]; then
    IFS=',' read -ra MOUNTS <<< "$BIND_MOUNTS"
    for mount in "${MOUNTS[@]}"; do
        ENROOT_MOUNTS="${ENROOT_MOUNTS} --mount ${mount}"
    done
fi

ENROOT_ENV="-e HF_HOME=${HF_HOME} \
    -e HF_TOKEN=${HF_TOKEN}"

# ============================================================================
# Run Preprocessing
# ============================================================================

echo "Starting preprocessing..."
echo ""

PYTHON_CMD="python /workspace/training/nemo/data/preprocess_data.py \
    --input ${CHUNK_FILE_CONTAINER} \
    --output-prefix ${OUTPUT_PREFIX_CONTAINER} \
    --tokenizer-model ${TOKENIZER} \
    --workers ${WORKERS} \
    --text-key ${JSON_KEY}"

echo "Command: ${PYTHON_CMD}"
echo ""

enroot start --rw \
    ${ENROOT_ENV} \
    ${ENROOT_MOUNTS} \
    ${CONTAINER_NAME} \
    bash -c "${PYTHON_CMD}" 2>&1 | tee ${LOG_DIR}/preprocessing.log

EXIT_CODE=$?

if [ $EXIT_CODE -eq 0 ]; then
    echo ""
    echo "============================================================================"
    echo "✓ Preprocessing Complete!"
    echo "============================================================================"
    
    # Show output files (on host filesystem)
    HOST_OUTPUT_DIR="${JOB_WORK_DIR}/data/processed"
    if ls ${HOST_OUTPUT_DIR}/chunk_$(printf '%04d' ${CHUNK_NUM})_text_document.* 1> /dev/null 2>&1; then
        echo "Output files:"
        ls -lh ${HOST_OUTPUT_DIR}/chunk_$(printf '%04d' ${CHUNK_NUM})_text_document.*
    else
        echo "Warning: Output files not found in ${HOST_OUTPUT_DIR}"
    fi
    
    echo ""
    echo "Log: ${LOG_DIR}/preprocessing.log"
    echo "============================================================================"
else
    echo ""
    echo "============================================================================"
    echo "✗ Preprocessing Failed (exit code: ${EXIT_CODE})"
    echo "============================================================================"
    echo "Check log: ${LOG_DIR}/preprocessing.log"
    echo "============================================================================"
    exit $EXIT_CODE
fi
